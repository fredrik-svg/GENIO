<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pi5 R√∂stassistent (Svenska)</title>
  <style>
    html, body { height:100%; margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:#0b1220; color:#eef2ff; }
    .wrap { min-height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:24px; padding:24px; }
    .btn { font-size:28px; padding:24px 32px; border-radius:20px; background:#1f2a44; border:2px solid #3c4a6b; color:#fff; cursor:pointer; }
    .btn:active { transform: scale(0.98); }
    .status { font-size:18px; opacity:0.9; }
    .bubble { max-width: 800px; width: 95%; padding: 16px 18px; border-radius: 16px; line-height: 1.4; }
    .user { background: #12233f; }
    .assistant { background: #1a2f54; }
    .context { background: #132f3d; font-size: 16px; }
    .context h3 { margin-top: 0; margin-bottom: 8px; font-size: 18px; }
    .context ol { margin: 0; padding-left: 20px; }
    .context li { margin-bottom: 6px; }
    .ask-form, .rag-form { display:flex; flex-wrap:wrap; gap:12px; justify-content:center; max-width:800px; width:95%; }
    .ask-input, .rag-input { flex:1 1 240px; padding:16px 18px; border-radius:16px; border:2px solid #3c4a6b; background:#0f1a2f; color:#eef2ff; font-size:20px; }
    .ask-input::placeholder { color:rgba(238,242,255,0.6); }
    .ask-submit { font-size:22px; padding:16px 24px; }
    .btn:disabled, .ask-submit:disabled { opacity:0.5; cursor:not-allowed; }
    .rag-reset { background:#51222d; border-color:#823648; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Pi5 R√∂stassistent üá∏üá™</h1>
    <button class="btn" id="talk">Tryck f√∂r att prata</button>
    <form class="ask-form" id="ask-form">
      <input
        class="ask-input"
        id="ask-input"
        type="text"
        name="question"
        placeholder="Skriv din fr√•ga h√§r"
        autocomplete="off"
      />
      <button class="btn ask-submit" type="submit" id="ask-submit">Skicka</button>
    </form>
    <form class="rag-form" id="rag-form">
      <input
        class="rag-input"
        id="rag-input"
        type="text"
        name="source"
        placeholder="Klistra in URL eller filv√§g till kunskapsk√§lla"
        autocomplete="off"
      />
      <button class="btn" type="submit" id="rag-submit">L√§gg till k√§lla</button>
      <button class="btn rag-reset" type="button" id="rag-reset">Rensa index</button>
    </form>
    <div class="status" id="status">Redo. S√§g ‚ÄùHej kompis‚Äù eller tryck p√• knappen.</div>
    <div id="log"></div>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const log = document.getElementById('log');
    const btn = document.getElementById('talk');
    const askForm = document.getElementById('ask-form');
    const askInput = document.getElementById('ask-input');
    const askSubmit = document.getElementById('ask-submit');
    const ragForm = document.getElementById('rag-form');
    const ragInput = document.getElementById('rag-input');
    const ragSubmit = document.getElementById('rag-submit');
    const ragReset = document.getElementById('rag-reset');

    let lastQuestion = '';
    let lastAnswer = '';
    let lastContexts = [];

    function renderConversation(){
      log.innerHTML = '';
      if(lastQuestion){
        const questionDiv = document.createElement('div');
        questionDiv.className = 'bubble user';
        questionDiv.textContent = 'Du: ' + lastQuestion;
        log.appendChild(questionDiv);
      }
      if(lastAnswer){
        const answerDiv = document.createElement('div');
        answerDiv.className = 'bubble assistant';
        answerDiv.textContent = 'Assistent: ' + lastAnswer;
        log.appendChild(answerDiv);
      }
      if(lastContexts.length){
        const contextDiv = document.createElement('div');
        contextDiv.className = 'bubble context';
        const title = document.createElement('h3');
        title.textContent = 'K√§llor';
        contextDiv.appendChild(title);
        const list = document.createElement('ol');
        lastContexts.forEach((ctx) => {
          const item = document.createElement('li');
          const label = ctx.title || ctx.source || 'Ok√§nd k√§lla';
          const score = typeof ctx.score === 'number' ? ` (match: ${(ctx.score * 100).toFixed(1)}%)` : '';
          item.innerHTML = `<strong>${label}</strong>${score}<br><small>${ctx.text}</small>`;
          list.appendChild(item);
        });
        contextDiv.appendChild(list);
        log.appendChild(contextDiv);
      }
    }

    function setQuestion(questionText){
      lastQuestion = questionText || '';
      if(lastQuestion){
        lastAnswer = '';
        lastContexts = [];
      }
      renderConversation();
    }

    function setAnswer(answerText){
      lastAnswer = answerText || '';
      renderConversation();
    }

    function setConversation(questionText, answerText){
      lastQuestion = questionText || '';
      lastAnswer = answerText || '';
      renderConversation();
    }

    function setContexts(contexts){
      lastContexts = Array.isArray(contexts) ? contexts : [];
      renderConversation();
    }

    btn.addEventListener('click', async () => {
      statusEl.textContent = 'Lyssnar ...';
      btn.disabled = true;
      try{
        const res = await fetch('/api/converse', { method:'POST' });
        const data = await res.json();
        if(data.ok){
          setConversation(data.question, data.answer);
          setContexts(data.contexts || []);
          statusEl.textContent = 'Klar. Tryck igen eller s√§g ‚ÄùHej kompis‚Äù.';
        }else{
          statusEl.textContent = 'H√∂rde inget ‚Äì prova igen.';
        }
      }catch(e){
        statusEl.textContent = 'Fel: ' + e;
      }finally{
        btn.disabled = false;
      }
    });

    askForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const question = askInput.value.trim();
      if(!question){
        askInput.focus();
        return;
      }

      statusEl.textContent = 'Skickar fr√•ga ...';
      askSubmit.disabled = true;
      askInput.disabled = true;

      try{
        const res = await fetch('/api/ask', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question })
        });
        const data = await res.json();
        if(res.ok && data.ok){
          setConversation(data.question, data.answer);
          setContexts(data.contexts || []);
          statusEl.textContent = 'Klar. St√§ll en ny fr√•ga eller prata med knappen.';
          askInput.value = '';
        }else{
          statusEl.textContent = data.error || 'Kunde inte f√• svar just nu.';
        }
      }catch(e){
        statusEl.textContent = 'Fel: ' + e;
      }finally{
        askSubmit.disabled = false;
        askInput.disabled = false;
        askInput.focus();
      }
    });

    ragForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const source = ragInput.value.trim();
      if(!source){
        ragInput.focus();
        return;
      }
      statusEl.textContent = 'L√§gger till k√§lla i kunskapsbasen ...';
      ragSubmit.disabled = true;
      ragReset.disabled = true;
      try{
        const res = await fetch('/api/rag/ingest', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sources: [source] })
        });
        const data = await res.json();
        if(res.ok && data.ok){
          statusEl.textContent = `Indexerade ${data.chunks_added} textdelar.`;
          ragInput.value = '';
        }else{
          statusEl.textContent = data.error || 'Kunde inte indexera k√§llan.';
        }
      }catch(err){
        statusEl.textContent = 'Fel: ' + err;
      }finally{
        ragSubmit.disabled = false;
        ragReset.disabled = false;
        ragInput.focus();
      }
    });

    ragReset.addEventListener('click', async () => {
      if(!confirm('√Ñr du s√§ker p√• att du vill rensa kunskapsbasen?')){
        return;
      }
      statusEl.textContent = 'Rensar kunskapsbas ...';
      ragSubmit.disabled = true;
      ragReset.disabled = true;
      try{
        const res = await fetch('/api/rag/reset', { method: 'POST' });
        const data = await res.json();
        if(res.ok && data.ok){
          statusEl.textContent = 'Kunskapsbasen √§r rensad.';
          setContexts([]);
        }else{
          statusEl.textContent = data.error || 'Kunde inte rensa kunskapsbasen.';
        }
      }catch(err){
        statusEl.textContent = 'Fel: ' + err;
      }finally{
        ragSubmit.disabled = false;
        ragReset.disabled = false;
      }
    });

    // websocket status
    const ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws');
    ws.onmessage = (ev) => {
      const msg = ev.data;
      if(msg.startsWith('status:')){
        statusEl.textContent = msg.replace('status:','').trim();
      }else if(msg.startsWith('du:')){
        setQuestion(msg.slice(3).trim());
      }else if(msg.startsWith('assistent:')){
        setAnswer(msg.slice(10).trim());
      }else if(msg.startsWith('context:')){
        try{
          const payload = JSON.parse(msg.slice(8));
          setContexts(payload);
        }catch(err){
          console.error('Kunde inte tolka context-meddelande', err);
        }
      }else if(msg.startsWith('fel:')){
        statusEl.textContent = msg;
      }
    };
  </script>
</body>
</html>

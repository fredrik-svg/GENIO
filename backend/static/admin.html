<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Administration – Pi5 Röstassistent</title>
  <style>
    :root {
      color-scheme: dark;
      --card-bg: rgba(16, 29, 52, 0.92);
      --card-border: rgba(37, 54, 89, 0.9);
    }
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background: radial-gradient(circle at top, #14213d, #0b1220);
      color: #eef2ff;
    }
    a { color: inherit; }
    .wrap {
      min-height: 100%;
      display: flex;
      flex-direction: column;
      gap: 24px;
      padding: 32px 24px 48px;
      max-width: 1000px;
      margin: 0 auto;
    }
    header {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }
    .title {
      font-size: 34px;
      margin: 0;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      padding: 12px 20px;
      border-radius: 14px;
      background: #1f2a44;
      border: 2px solid #3c4a6b;
      color: #fff;
      cursor: pointer;
      text-decoration: none;
      transition: transform 0.1s ease;
    }
    .btn:active { transform: scale(0.98); }
    .btn.danger { background: #51222d; border-color: #823648; }
    .btn.secondary { background: #13233d; border-color: #2a3b5f; }
    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 22px;
      padding: 26px;
      box-shadow: 0 25px 45px rgba(0, 0, 0, 0.25);
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .card h2 { margin: 0; font-size: 24px; }
    .helper { margin: 0; opacity: 0.85; }
    label { display: block; font-weight: 600; margin-bottom: 8px; }
    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex: 1 1 220px;
    }
    .field input,
    .field select,
    .field textarea {
      padding: 14px 16px;
      border-radius: 14px;
      border: 2px solid #3c4a6b;
      background: rgba(15, 26, 47, 0.9);
      color: #eef2ff;
      font-size: 16px;
      font-family: inherit;
    }
    .field small {
      font-size: 14px;
      opacity: 0.75;
    }
    .field input[type="color"] {
      padding: 0;
      height: 48px;
      cursor: pointer;
    }
    .grid {
      display: flex;
      flex-wrap: wrap;
      gap: 18px;
    }
    .name-preview {
      font-size: 22px;
      font-weight: 600;
      padding: 14px 18px;
      border-radius: 14px;
      background: rgba(18, 36, 70, 0.9);
      border: 1px solid rgba(76, 101, 150, 0.6);
    }
    .name-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .name-options button {
      font-size: 14px;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid rgba(92, 123, 184, 0.7);
      background: rgba(25, 45, 82, 0.85);
      color: inherit;
      cursor: pointer;
    }
    .name-options button:hover { background: rgba(40, 66, 118, 0.9); }
    .status { font-size: 16px; opacity: 0.9; }
    .log {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .log-entry {
      padding: 16px 18px;
      border-radius: 16px;
      background: #132f3d;
      border: 1px solid #214a61;
      line-height: 1.4;
      font-size: 16px;
    }
    .log-entry.success { border-color: #1b7750; background: #12392d; }
    .log-entry.error { border-color: #7a2c2c; background: #3f1b22; }
    .log-entry small {
      display: block;
      margin-top: 8px;
      opacity: 0.75;
    }
    .lan-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .lan-group h3 {
      margin: 0;
      font-size: 18px;
    }
    .link-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .link-item {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      padding: 12px 14px;
      border-radius: 14px;
      background: rgba(19, 36, 63, 0.9);
      border: 1px solid rgba(62, 96, 146, 0.55);
    }
    .link-item a {
      color: #9bc9ff;
      font-weight: 600;
      text-decoration: none;
      word-break: break-all;
      flex: 1 1 220px;
    }
    .link-item a:hover {
      text-decoration: underline;
    }
    .copy-btn {
      background: rgba(30, 55, 94, 0.95);
      border: 1px solid rgba(90, 128, 185, 0.7);
      color: #eef2ff;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 14px;
      cursor: pointer;
      transition: transform 0.1s ease;
    }
    .copy-btn:active {
      transform: scale(0.97);
    }
    @media (max-width: 720px) {
      .wrap { padding: 24px 16px 40px; }
      header { justify-content: center; }
      .btn { width: 100%; }
      .link-item {
        flex-direction: column;
        align-items: stretch;
      }
      .copy-btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 class="title">Administration</h1>
      <a class="btn secondary" href="/">⬅ Tillbaka till assistenten</a>
    </header>

    <div class="card" id="appearance-card">
      <div>
        <h2>Bygg assistentens identitet</h2>
        <p class="helper">Sätt namn, bakgrund, typsnitt och färger som gäller för startsidan. Förhandsgranska namnet nedan.</p>
      </div>
      <form id="appearance-form">
        <div class="grid">
          <div class="field">
            <label for="name-prefix">Prefix</label>
            <input id="name-prefix" name="name-prefix" type="text" placeholder="t.ex. Team" />
          </div>
          <div class="field">
            <label for="name-core">Huvudnamn</label>
            <input id="name-core" name="name-core" type="text" placeholder="t.ex. Genio" />
          </div>
          <div class="field">
            <label for="name-suffix">Suffix</label>
            <input id="name-suffix" name="name-suffix" type="text" placeholder="t.ex. AI" />
          </div>
        </div>
        <div class="name-options" aria-label="Namnsförslag">
          <span>Snabbval:</span>
          <button type="button" data-name-part="prefix" data-value="Team">Team</button>
          <button type="button" data-name-part="prefix" data-value="Projekt">Projekt</button>
          <button type="button" data-name-part="core" data-value="Genio">Genio</button>
          <button type="button" data-name-part="core" data-value="Kompis">Kompis</button>
          <button type="button" data-name-part="core" data-value="Vision">Vision</button>
          <button type="button" data-name-part="suffix" data-value="AI">AI</button>
          <button type="button" data-name-part="suffix" data-value="Assist">Assist</button>
          <button type="button" data-name-part="suffix" data-value="Hub">Hub</button>
        </div>
        <div class="field">
          <label for="assistant-name">Resultat</label>
          <input id="assistant-name" name="assistant-name" type="text" placeholder="Skriv fritt eller använd byggaren" />
        </div>
        <div class="name-preview">Förhandsvisning: <span id="assistant-preview">Pi5 Röstassistent</span></div>
        <hr />
        <div class="grid">
          <div class="field">
            <label for="background-image">Bakgrundsbild</label>
            <input id="background-image" name="background-image" type="text" placeholder="https://.../bild.jpg" />
            <input id="background-upload" name="background-upload" type="file" accept="image/*" />
            <small id="background-upload-feedback">Ange en URL eller välj en bild från datorn (max 6 MB).</small>
          </div>
          <div class="field">
            <label for="font-family">Typsnitt</label>
            <input id="font-family" name="font-family" type="text" list="font-options" placeholder="system-ui, sans-serif" />
            <datalist id="font-options">
              <option value="system-ui, -apple-system, 'Segoe UI', Roboto, Arial"></option>
              <option value="'Poppins', 'Segoe UI', sans-serif"></option>
              <option value="'Montserrat', 'Segoe UI', sans-serif"></option>
              <option value="'Fira Sans', 'Segoe UI', sans-serif"></option>
              <option value="'Merriweather', Georgia, serif"></option>
            </datalist>
          </div>
        </div>
        <div class="grid">
          <div class="field">
            <label for="primary-button-color">Primär knapfärg</label>
            <input id="primary-button-color" name="primary-button-color" type="color" value="#1f2a44" />
          </div>
          <div class="field">
            <label for="secondary-button-color">Sekundär knapfärg</label>
            <input id="secondary-button-color" name="secondary-button-color" type="color" value="#13233d" />
          </div>
          <div class="field">
            <label for="button-text-color">Textfärg på knappar</label>
            <input id="button-text-color" name="button-text-color" type="color" value="#ffffff" />
          </div>
        </div>
        <div class="grid">
          <button class="btn" id="appearance-submit" type="submit">Spara utseende</button>
        </div>
      </form>
      <div class="status" id="appearance-status">Inställningarna gäller för startsidan.</div>
    </div>

    <div class="card" id="lan-card">
      <div>
        <h2>Öppna från andra enheter</h2>
        <p class="helper" id="lan-status">Söker tillgängliga adresser på nätverket ...</p>
      </div>
      <div class="lan-group" aria-live="polite">
        <h3>Administration</h3>
        <ul class="link-list" id="lan-admin-list"></ul>
      </div>
      <div class="lan-group" aria-live="polite">
        <h3>Visningsläge</h3>
        <ul class="link-list" id="lan-display-list"></ul>
      </div>
    </div>

    <div class="card" id="audio-card">
      <div>
        <h2>Välj ljudkälla</h2>
        <p class="helper">Välj vilken mikrofon backend ska använda för inspelning.</p>
      </div>
      <form id="audio-form">
        <div class="field">
          <label for="audio-input-select">Inspelningskälla</label>
          <select id="audio-input-select" name="input-device">
            <option value="auto">Systemets standard</option>
            <option value="manual">Ange manuellt värde ...</option>
          </select>
          <small>Om din mikrofon inte visas kan du ange namn eller index manuellt.</small>
        </div>
        <div class="field" id="audio-custom-field" style="display:none;">
          <label for="audio-custom-input">Manuell ljudkälla</label>
          <input id="audio-custom-input" name="audio-custom-input" type="text" placeholder="t.ex. hw:2,0" />
          <small>Ange exakt namn, index eller ALSA-sträng.</small>
        </div>
        <div class="grid">
          <button class="btn secondary" type="button" id="audio-refresh">Uppdatera lista</button>
          <button class="btn" type="submit" id="audio-save">Spara ljudkälla</button>
        </div>
      </form>
      <div class="status" id="audio-status">Ingen specifik ljudkälla vald – systemets standard används.</div>
    </div>

    <div class="card">
      <div>
        <h2>Hantera kunskapsbas (RAG)</h2>
        <p class="helper">Indexera nya källor eller rensa befintligt innehåll.</p>
      </div>
      <form class="grid" id="rag-form">
        <div class="field" style="flex:1 1 100%">
          <label for="rag-input">Källor att indexera</label>
          <textarea
            class="rag-input"
            id="rag-input"
            name="sources"
            rows="4"
            placeholder="https://exempel.se/dokument.pdf&#10;/home/pi/dokument.txt"
          ></textarea>
        </div>
        <button class="btn" type="submit" id="rag-submit">Indexera källor</button>
        <button class="btn danger" type="button" id="rag-reset">Rensa kunskapsbasen</button>
      </form>
      <div class="status" id="status">Redo.</div>
      <div class="log" id="log" aria-live="polite"></div>
    </div>
  </div>

  <script>
    const appearanceForm = document.getElementById('appearance-form');
    const namePrefix = document.getElementById('name-prefix');
    const nameCore = document.getElementById('name-core');
    const nameSuffix = document.getElementById('name-suffix');
    const assistantNameInput = document.getElementById('assistant-name');
    const assistantPreview = document.getElementById('assistant-preview');
    const backgroundInput = document.getElementById('background-image');
    const backgroundUploadInput = document.getElementById('background-upload');
    const backgroundUploadFeedback = document.getElementById('background-upload-feedback');
    const fontInput = document.getElementById('font-family');
    const primaryColorInput = document.getElementById('primary-button-color');
    const secondaryColorInput = document.getElementById('secondary-button-color');
    const buttonTextColorInput = document.getElementById('button-text-color');
    const appearanceStatus = document.getElementById('appearance-status');
    const ragForm = document.getElementById('rag-form');
    const ragInput = document.getElementById('rag-input');
    const ragSubmit = document.getElementById('rag-submit');
    const ragReset = document.getElementById('rag-reset');
    const statusEl = document.getElementById('status');
    const log = document.getElementById('log');
    const lanStatus = document.getElementById('lan-status');
    const lanAdminList = document.getElementById('lan-admin-list');
    const lanDisplayList = document.getElementById('lan-display-list');
    const audioForm = document.getElementById('audio-form');
    const audioSelect = document.getElementById('audio-input-select');
    const audioManualField = document.getElementById('audio-custom-field');
    const audioManualInput = document.getElementById('audio-custom-input');
    const audioRefreshBtn = document.getElementById('audio-refresh');
    const audioStatus = document.getElementById('audio-status');
    const backgroundUploadDefaultText = backgroundUploadFeedback ? backgroundUploadFeedback.textContent : '';
    let lanStatusDefault = lanStatus ? lanStatus.textContent : '';
    const clipboardAvailable = !!(navigator.clipboard && typeof navigator.clipboard.writeText === 'function');

    const defaultSettings = {
      assistantName: 'Pi5 Röstassistent',
      backgroundImage: '',
      fontFamily: "system-ui, -apple-system, 'Segoe UI', Roboto, Arial",
      primaryButtonColor: '#1f2a44',
      secondaryButtonColor: '#13233d',
      buttonTextColor: '#ffffff'
    };

    function setLanStatus(text, persist = false){
      if(!lanStatus){
        return;
      }
      lanStatus.textContent = text;
      if(persist){
        lanStatusDefault = text;
      }
    }

    function flashLanStatus(text){
      if(!lanStatus){
        return;
      }
      lanStatus.textContent = text;
      window.setTimeout(() => {
        if(lanStatus){
          lanStatus.textContent = lanStatusDefault || '';
        }
      }, 3200);
    }

    function toggleAudioManualField(show){
      if(!audioManualField){
        return;
      }
      audioManualField.style.display = show ? '' : 'none';
    }

    function manualValueFromRaw(raw){
      if(typeof raw !== 'string'){
        return '';
      }
      if(raw.startsWith('manual:')){
        return raw.slice(7).trim();
      }
      return '';
    }

    function determineAudioOption(raw, fallback){
      if(typeof raw === 'string'){
        const trimmed = raw.trim();
        if(trimmed){
          if(trimmed.startsWith('manual:')){
            return 'manual';
          }
          return trimmed;
        }
      }
      return fallback || 'auto';
    }

    function populateAudioSelectOptions(devices, selectedRaw, selectedOption){
      if(!audioSelect){
        return;
      }

      const safeDevices = Array.isArray(devices) ? devices : [];
      const raw = typeof selectedRaw === 'string' ? selectedRaw : '';
      const option = typeof selectedOption === 'string' && selectedOption.trim()
        ? selectedOption.trim()
        : null;
      const manualValue = manualValueFromRaw(raw);
      const targetValue = option || determineAudioOption(raw, 'auto');

      audioSelect.innerHTML = '';

      const autoOption = document.createElement('option');
      autoOption.value = 'auto';
      autoOption.textContent = 'Systemets standard';
      audioSelect.appendChild(autoOption);

      const manualOption = document.createElement('option');
      manualOption.value = 'manual';
      manualOption.textContent = 'Ange manuellt värde ...';
      audioSelect.appendChild(manualOption);

      safeDevices.forEach((device) => {
        const optionEl = document.createElement('option');
        const value = typeof device.value === 'string' && device.value.trim()
          ? device.value.trim()
          : `index:${device.index}`;
        optionEl.value = value;

        let label = '';
        if(typeof device.name === 'string' && device.name.trim()){
          label = device.name.trim();
        } else if(typeof device.index === 'number'){
          label = `Enhet ${device.index}`;
        } else {
          label = value;
        }

        const channels = typeof device.maxInputChannels === 'number' ? device.maxInputChannels : null;
        if(channels && channels > 0){
          label += ` – ${channels} kanal${channels === 1 ? '' : 'er'}`;
        }

        const hostapi = typeof device.hostapi === 'string' && device.hostapi.trim() ? device.hostapi.trim() : '';
        if(hostapi){
          label += ` (${hostapi})`;
        }

        if(device.isDefault){
          label += ' (systemstandard)';
        }

        optionEl.textContent = label;
        audioSelect.appendChild(optionEl);
      });

      if(targetValue && targetValue !== 'auto' && targetValue !== 'manual'){
        const hasTarget = safeDevices.some((device) => {
          const value = typeof device.value === 'string' && device.value.trim()
            ? device.value.trim()
            : `index:${device.index}`;
          return value === targetValue;
        });
        if(!hasTarget){
          const fallbackOption = document.createElement('option');
          fallbackOption.value = targetValue;
          fallbackOption.textContent = `Tidigare vald: ${targetValue}`;
          fallbackOption.dataset.missing = '1';
          audioSelect.appendChild(fallbackOption);
        }
      }

      audioSelect.value = targetValue || 'auto';
      if(audioSelect.value !== (targetValue || 'auto')){
        audioSelect.value = targetValue === 'manual' ? 'manual' : 'auto';
      }

      toggleAudioManualField(audioSelect.value === 'manual');
      if(audioManualInput){
        audioManualInput.value = manualValue;
      }
    }

    function setAudioStatus(text){
      if(!audioStatus){
        return;
      }
      audioStatus.textContent = text;
    }

    async function loadAudioDevices(showLoading = true){
      if(!audioForm || !audioSelect){
        return;
      }
      if(audioStatus && showLoading){
        setAudioStatus('Hämtar ljudenheter ...');
      }
      try {
        const res = await fetch('/api/audio/input-devices');
        const data = await res.json();
        const devices = data && Array.isArray(data.devices) ? data.devices : [];
        const selectedRaw = data && typeof data.selected === 'string' ? data.selected : '';
        const selectedOption = data && typeof data.selectedOption === 'string' ? data.selectedOption : undefined;
        populateAudioSelectOptions(devices, selectedRaw, selectedOption);
        if(audioStatus){
          if(data && typeof data.message === 'string' && data.message.trim()){
            audioStatus.textContent = data.message;
          } else if(res.ok){
            audioStatus.textContent = 'Ljudenheter uppdaterade.';
          } else {
            audioStatus.textContent = data && typeof data.error === 'string' ? data.error : 'Kunde inte hämta ljudenheter.';
          }
        }
      } catch (err) {
        if(audioStatus){
          audioStatus.textContent = 'Kunde inte hämta ljudenheter.';
        }
        console.error('Kunde inte hämta ljudenheter', err);
      }
    }

    function renderLanLinks(urls, listEl){
      if(!listEl){
        return;
      }
      listEl.innerHTML = '';
      const safeUrls = Array.isArray(urls) ? urls : [];
      if(!safeUrls.length){
        const emptyItem = document.createElement('li');
        emptyItem.className = 'link-item';
        emptyItem.textContent = 'Inga adresser hittades.';
        listEl.appendChild(emptyItem);
        return;
      }

      safeUrls.forEach((url) => {
        const item = document.createElement('li');
        item.className = 'link-item';
        const anchor = document.createElement('a');
        anchor.href = url;
        anchor.target = '_blank';
        anchor.rel = 'noopener noreferrer';
        anchor.textContent = url;
        item.appendChild(anchor);

        if(clipboardAvailable){
          const copyBtn = document.createElement('button');
          copyBtn.type = 'button';
          copyBtn.className = 'copy-btn';
          copyBtn.textContent = 'Kopiera';
          copyBtn.addEventListener('click', async () => {
            try {
              await navigator.clipboard.writeText(url);
              flashLanStatus('Länken kopierades till urklipp.');
            } catch (err) {
              console.error('Kunde inte kopiera länken', err);
              flashLanStatus('Kunde inte kopiera länken.');
            }
          });
          item.appendChild(copyBtn);
        }

        listEl.appendChild(item);
      });
    }

    async function loadLanLinks(){
      if(!lanAdminList || !lanDisplayList){
        return;
      }
      setLanStatus('Söker tillgängliga adresser på nätverket ...');
      try {
        const res = await fetch('/api/network/lan-info');
        const data = await res.json();
        if(res.ok && data && data.ok){
          renderLanLinks(data.adminUrls || data.admin_urls || [], lanAdminList);
          renderLanLinks(data.displayUrls || data.display_urls || [], lanDisplayList);
          const lanAddresses = Array.isArray(data.lanAddresses) ? data.lanAddresses : [];
          let message = typeof data.note === 'string' && data.note.trim()
            ? data.note.trim()
            : 'Öppna länkarna från en annan enhet på samma nätverk.';
          if(!lanAddresses.length && (!Array.isArray(data.baseUrls) || !data.baseUrls.length)){
            message = 'Kunde inte hitta några adresser automatiskt. Använd adressen du redan har öppnat.';
          }
          setLanStatus(message, true);
        } else {
          const errorText = data && data.error ? data.error : 'Kunde inte hämta nätverksadresser.';
          setLanStatus(errorText, true);
          renderLanLinks([], lanAdminList);
          renderLanLinks([], lanDisplayList);
        }
      } catch (err) {
        console.error('Kunde inte hämta nätverksinformation', err);
        setLanStatus('Kunde inte hämta nätverksadresser.', true);
        renderLanLinks([], lanAdminList);
        renderLanLinks([], lanDisplayList);
      }
    }

    function updateNameFromBuilder(){
      const parts = [namePrefix.value.trim(), nameCore.value.trim(), nameSuffix.value.trim()].filter(Boolean);
      if(parts.length){
        assistantNameInput.value = parts.join(' ');
      }
      updateNamePreview();
    }

    function updateNamePreview(){
      const value = assistantNameInput.value.trim();
      assistantPreview.textContent = value || '—';
    }

    document.querySelectorAll('[data-name-part]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const part = btn.getAttribute('data-name-part');
        const value = btn.getAttribute('data-value');
        if(part === 'prefix') namePrefix.value = value;
        if(part === 'core') nameCore.value = value;
        if(part === 'suffix') nameSuffix.value = value;
        updateNameFromBuilder();
      });
    });

    [namePrefix, nameCore, nameSuffix].forEach((input) => {
      input.addEventListener('input', updateNameFromBuilder);
    });

    assistantNameInput.addEventListener('input', updateNamePreview);

    if(backgroundUploadInput){
      backgroundUploadInput.addEventListener('change', async () => {
        const file = backgroundUploadInput.files && backgroundUploadInput.files[0];
        if(!file){
          return;
        }

        if(backgroundUploadFeedback){
          backgroundUploadFeedback.textContent = 'Laddar upp bakgrundsbild ...';
        }

        const formData = new FormData();
        formData.append('file', file);

        let resetFeedback = true;
        try {
          const res = await fetch('/api/ui-settings/background-image', {
            method: 'POST',
            body: formData
          });
          const data = await res.json();
          if(res.ok && data.ok){
            backgroundInput.value = data.backgroundImage || '';
            if(backgroundUploadFeedback){
              backgroundUploadFeedback.textContent = 'Bakgrundsbilden är uppladdad och sparad.';
            }
            if(appearanceStatus){
              appearanceStatus.textContent = 'Bakgrundsbilden är uppladdad och sparad.';
            }
          } else {
            if(backgroundUploadFeedback){
              backgroundUploadFeedback.textContent = data.error || 'Kunde inte ladda upp bilden.';
            }
            resetFeedback = false;
          }
        } catch (err) {
          console.error('Uppladdning av bakgrundsbild misslyckades', err);
          if(backgroundUploadFeedback){
            backgroundUploadFeedback.textContent = 'Ett fel inträffade vid uppladdningen.';
          }
          resetFeedback = false;
        } finally {
          backgroundUploadInput.value = '';
          if(resetFeedback && backgroundUploadFeedback){
            setTimeout(() => {
              backgroundUploadFeedback.textContent = backgroundUploadDefaultText;
            }, 4000);
          }
        }
      });
    }

    async function loadSettings(){
      try {
        const res = await fetch('/api/ui-settings');
        const data = await res.json();
        if(res.ok && data.ok && data.settings){
          applySettingsToForm(data.settings);
        } else {
          applySettingsToForm(defaultSettings);
        }
      } catch (err) {
        console.error('Kunde inte läsa inställningar', err);
        applySettingsToForm(defaultSettings);
      }
    }

    function applySettingsToForm(settings){
      const merged = { ...defaultSettings, ...settings };
      assistantNameInput.value = merged.assistantName || defaultSettings.assistantName;
      backgroundInput.value = merged.backgroundImage || '';
      fontInput.value = merged.fontFamily || defaultSettings.fontFamily;
      primaryColorInput.value = merged.primaryButtonColor || defaultSettings.primaryButtonColor;
      secondaryColorInput.value = merged.secondaryButtonColor || defaultSettings.secondaryButtonColor;
      buttonTextColorInput.value = merged.buttonTextColor || defaultSettings.buttonTextColor;
      updateNamePreview();
    }

    toggleAudioManualField(audioSelect && audioSelect.value === 'manual');

    if(audioSelect){
      audioSelect.addEventListener('change', () => {
        const isManual = audioSelect.value === 'manual';
        toggleAudioManualField(isManual);
        if(isManual && audioManualInput){
          audioManualInput.focus();
        }
      });
    }

    if(audioRefreshBtn){
      audioRefreshBtn.addEventListener('click', () => {
        loadAudioDevices(false);
      });
    }

    if(audioForm){
      audioForm.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        if(!audioSelect){
          return;
        }

        const choice = audioSelect.value;
        let manualValue = '';
        if(choice === 'manual'){
          manualValue = audioManualInput ? audioManualInput.value.trim() : '';
          if(!manualValue){
            if(audioStatus){
              audioStatus.textContent = 'Ange en manuell ljudkälla.';
            }
            if(audioManualInput){
              audioManualInput.focus();
            }
            return;
          }
        } else if(choice.startsWith('manual:')){
          manualValue = audioManualInput ? audioManualInput.value.trim() : '';
        }

        if(audioStatus){
          audioStatus.textContent = 'Sparar ljudkälla ...';
        }

        try {
          const res = await fetch('/api/audio/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              inputDevice: choice,
              manualValue: manualValue
            })
          });
          const data = await res.json();
          if(res.ok && data){
            const devices = Array.isArray(data.devices) ? data.devices : [];
            const selectedRaw = typeof data.selected === 'string' ? data.selected : '';
            const selectedOption = typeof data.selectedOption === 'string' ? data.selectedOption : undefined;
            populateAudioSelectOptions(devices, selectedRaw, selectedOption);
            if(audioStatus){
              if(typeof data.message === 'string' && data.message.trim()){
                audioStatus.textContent = data.message;
              } else {
                audioStatus.textContent = 'Ljudkälla sparad.';
              }
            }
          } else {
            if(audioStatus){
              const errMsg = data && typeof data.error === 'string' ? data.error : 'Kunde inte spara ljudkälla.';
              audioStatus.textContent = errMsg;
            }
          }
        } catch (err) {
          if(audioStatus){
            audioStatus.textContent = 'Ett fel inträffade vid sparande av ljudkälla.';
          }
          console.error('Kunde inte spara ljudkälla', err);
        }
      });
    }

    appearanceForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const payload = {
        assistantName: assistantNameInput.value.trim() || defaultSettings.assistantName,
        backgroundImage: backgroundInput.value.trim(),
        fontFamily: fontInput.value.trim() || defaultSettings.fontFamily,
        primaryButtonColor: primaryColorInput.value,
        secondaryButtonColor: secondaryColorInput.value,
        buttonTextColor: buttonTextColorInput.value
      };

      appearanceStatus.textContent = 'Sparar inställningar ...';
      try {
        const res = await fetch('/api/ui-settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if(res.ok && data.ok){
          appearanceStatus.textContent = 'Inställningarna är sparade.';
        } else {
          appearanceStatus.textContent = data.error || 'Kunde inte spara inställningarna.';
        }
      } catch (err){
        appearanceStatus.textContent = 'Ett fel inträffade vid sparande.';
        console.error(err);
      }
    });

    function pushLog(message, type = 'info', meta = ''){
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`.trim();
      entry.textContent = message;
      if(meta){
        const small = document.createElement('small');
        small.textContent = meta;
        entry.appendChild(small);
      }
      log.prepend(entry);
    }

    ragForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const raw = ragInput.value.trim();
      if(!raw){
        ragInput.focus();
        return;
      }

      const sources = raw.split(/\n+/).map((s) => s.trim()).filter(Boolean);
      if(!sources.length){
        ragInput.focus();
        return;
      }

      statusEl.textContent = 'Indexerar källor ...';
      ragSubmit.disabled = true;
      ragReset.disabled = true;
      ragInput.disabled = true;
      try {
        const res = await fetch('/api/rag/ingest', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sources })
        });
        const data = await res.json();
        if(res.ok && data.ok){
          const added = typeof data.chunks_added === 'number' ? data.chunks_added : 'okänt antal';
          statusEl.textContent = `Indexerade ${added} textdelar.`;
          pushLog(`Källa${sources.length > 1 ? 'r' : ''} indexerade.`, 'success', sources.join('\n'));
          ragInput.value = '';
        } else {
          const error = data.error || 'Kunde inte indexera källorna.';
          statusEl.textContent = error;
          pushLog(error, 'error', sources.join('\n'));
        }
      } catch (err){
        statusEl.textContent = 'Fel: ' + err;
        pushLog('Ett fel inträffade vid indexering.', 'error');
      } finally {
        ragSubmit.disabled = false;
        ragReset.disabled = false;
        ragInput.disabled = false;
        ragInput.focus();
      }
    });

    ragReset.addEventListener('click', async () => {
      if(!confirm('Är du säker på att du vill rensa kunskapsbasen?')){
        return;
      }
      statusEl.textContent = 'Rensar kunskapsbas ...';
      ragSubmit.disabled = true;
      ragReset.disabled = true;
      ragInput.disabled = true;
      try {
        const res = await fetch('/api/rag/reset', { method: 'POST' });
        const data = await res.json();
        if(res.ok && data.ok){
          statusEl.textContent = 'Kunskapsbasen är rensad.';
          pushLog('Kunskapsbasen rensades.', 'success');
        } else {
          const error = data.error || 'Kunde inte rensa kunskapsbasen.';
          statusEl.textContent = error;
          pushLog(error, 'error');
        }
      } catch (err){
        statusEl.textContent = 'Fel: ' + err;
        pushLog('Ett fel inträffade vid rensning.', 'error');
      } finally {
        ragSubmit.disabled = false;
        ragReset.disabled = false;
        ragInput.disabled = false;
      }
    });

    loadAudioDevices();
    loadLanLinks();
    loadSettings();
  </script>
</body>
</html>
